<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.9.2/css/layui.css">
    <style>
        body {
          background-color: white;
        }
    </style>
</head>

<body>
    <H1 style="text-align: center;">ESP32-水族控制板V1.0</H1>
    <div class="layui-tab layui-tab-brief">
        <ul class="layui-tab-title">
            <li class="layui-this"><i class="layui-icon layui-icon-console"></i> 鱼缸状态</li>
            <li><i class="layui-icon layui-icon-chart"></i> 灯光配置</li>
            <li><i class="layui-icon layui-icon-water"></i> 换水配置</li>
            <li><i class="layui-icon layui-icon-water"></i> 补水配置</li>
            <li><i class="layui-icon layui-icon-set-sm"></i> 其他配置</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div style="padding: 16px;">
                    <div class="layui-row layui-col-space15">

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">鱼缸当前温度</div>
                                <div class="layui-card-body">
                                    <H2 style="text-align: center;">0°</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">最近补水时间</div>
                                <div class="layui-card-body">
                                    <H2 style="text-align: center;">2023-12-29</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">最近换水时间</div>
                                <div class="layui-card-body">
                                    <H2 style="text-align: center;">2023-12-29 5L</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">LED状态(RGBWU)
                                </div>
                                <div class="layui-card-body">
                                    <H2 style="text-align: center;">10,20,30,40,50</H2>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="layui-timeline" style="padding: 16px;">
                    <div class="layui-timeline-item">
                        <i class="layui-icon layui-timeline-axis"></i>
                        <div class="layui-timeline-content layui-text">
                            <h3 class="layui-timeline-title">12月29日</h3>
                            <p>
                                开始补水......
                            </p>
                        </div>
                    </div>
                </div>

            </div>

            <div class="layui-tab-item">
                <form class="layui-form" action="" id='updateForm'>
                    <div id="sun_led_controller_1" class="layui-form-item">
                        <div class="layui-box" style="margin-left: 20px;position: relative; height:60vh; width:100vw">
                            <canvas id='myChart'></canvas>
                        </div>
                    </div>

                    <div id="sun_led_controller_0" class="layui-form-item">
                        <div class="layui-box" style="margin-left: 38px;">
                            <div style="height: 50px; width: 50%;" id="ID-slider-R-input"></div>
                            <div style="height: 50px; width: 50%;" id="ID-slider-G-input"></div>
                            <div style="height: 50px; width: 50%;" id="ID-slider-B-input"></div>
                            <div style="height: 50px; width: 50%;" id="ID-slider-W-input"></div>
                            <div style="height: 50px; width: 50%;" id="ID-slider-U-input"></div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">LED模式</label>
                        <div class="layui-input-block">
                            <input type="radio" name="LEDMode" value="0" lay-filter="led-radio-filter" title="手动调节">
                            <input type="radio" name="LEDMode" value="1" lay-filter="led-radio-filter" title="日出日落" checked>
                        </div>
                    </div>


                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn" style="width: 300px;" lay-submit
                                lay-filter="formUpdate">保存</button>
                        </div>
                    </div>

                </form>

            </div>
            <div class="layui-tab-item">3</div>
            <div class="layui-tab-item">4</div>
            <div class="layui-tab-item">5</div>
            <div class="layui-tab-item">6</div>
        </div>
    </div>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.9.2/layui.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.4/dist/chartjs-plugin-dragdata.js"></script>


<script>
    const currentDomain = window.location.hostname;

    const socket = new WebSocket("ws://" + currentDomain + ":81");

    // 监听连接打开事件
    socket.addEventListener('open', (event) => {
        console.log('WebSocket connection opened:', event);
    });

    // 监听消息事件
    socket.addEventListener('message', (event) => {
        console.log('WebSocket received message:', event.data);
    });

    // 监听连接关闭事件
    socket.addEventListener('close', (event) => {
        console.log('WebSocket connection closed:', event);
    });

    // 监听连接错误事件
    socket.addEventListener('error', (event) => {
        // layer.msg(event);
        console.error('WebSocket connection error:', event);
    });

    var jsonResponse = {
        isEnableAddWather: 1,
        isEnableWaterChanges: 1,
        isEnableSunTime: 1,
        TemperatureControlMode: 1,
        changesWaterTiming: 0,
        pwmValuesPerHour: [
            { "0": [0, 0, 0, 0, 0] },
            { "1": [0, 0, 0, 0, 0] },
            { "2": [0, 0, 0, 0, 0] },
            { "3": [0, 0, 0, 0, 0] },
            { "4": [0, 0, 0, 0, 0] },
            { "5": [0, 0, 0, 0, 0] },
            { "6": [0, 0, 0, 0, 0] },
            { "7": [0, 0, 0, 0, 0] },
            { "8": [0, 0, 0, 0, 0] },
            { "9": [0, 0, 0, 0, 0] },
            { "10": [20, 10, 30, 30, 30] },
            { "11": [30, 30, 40, 30, 50] },
            { "12": [50, 30, 100, 50, 50] },
            { "13": [50, 30, 100, 100, 100] },
            { "14": [50, 30, 80, 80, 80] },
            { "15": [40, 30, 80, 80, 80] },
            { "16": [30, 30, 60, 30, 50] },
            { "17": [30, 30, 50, 30, 50] },
            { "18": [30, 30, 40, 30, 50] },
            { "19": [30, 30, 30, 30, 50] },
            { "20": [30, 30, 30, 30, 50] },
            { "21": [30, 30, 30, 30, 50] },
            { "22": [10, 10, 10, 10, 10] },
            { "23": [0, 0, 0, 0, 0] }
        ],
        pushKey: ""
    };
    // var jsonResponse = {};
    // 初始化数据集
    var espDatasets = [
        { label: 'R', data: [], borderWidth: 1, borderColor: 'red', fill: true },
        { label: 'G', data: [], borderWidth: 1, borderColor: 'green', fill: true },
        { label: 'B', data: [], borderWidth: 1, borderColor: 'blue', fill: true },
        { label: 'W', data: [], borderWidth: 1, borderColor: 'white', fill: true },
        { label: 'U', data: [], borderWidth: 1, borderColor: 'purple', fill: true }
    ];

    layui.use('slider', function () {
        var slider = layui.slider;

        //渲染
        slider.render({
            elem: '#slideTest1'  //绑定元素
        });
    });

    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
        // plugins:[]
        type: 'line',
        data: {
            labels: ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"],
            datasets: []
        },
        options: {
            responsive: true,  // 设置图表为响应式
            interaction: {  // 设置每个点的交互
                intersect: true,
            },
            title: {
                display: true,
                text: "LED灯光设置"
            },
            scales: {
                y: {
                    min: 0,
                    max: 100
                }
            },
            onHover: function (e) {
                const point = e.chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false)
                if (point.length) e.native.target.style.cursor = 'grab'
                else e.native.target.style.cursor = 'default'
            },
            plugins: {
                dragData: {
                    round: 1,
                    showTooltip: true,
                    onDragStart: function (e, datasetIndex, index, value) {
                        //   console.log(e)
                    },
                    onDrag: function (e, datasetIndex, index, value) {
                        e.target.style.cursor = 'grabbing'
                        //   console.log(e, datasetIndex, index, value)
                    },
                    onDragEnd: function (e, datasetIndex, index, value) {
                        e.target.style.cursor = 'default'
                        espDatasets[datasetIndex].data[index] = value;
                        jsonResponse.pwmValuesPerHour[index][String(index)][datasetIndex] = value;
                        console.log(espDatasets);
                        console.log(jsonResponse);
                    },
                }
            }
        },
    });


    function requestData() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', currentDomain + '/api/data', true);
        // xhr.responseType = 'json';
        // xhr.onload = function () {
        //     if (xhr.status === 200) {
                // jsonResponse = xhr.response;
                // 遍历pwmValuesPerHour中的每个对象
                jsonResponse.pwmValuesPerHour.forEach(entry => {
                    // 获取每个对象的第一个值
                    const values = Object.values(entry)[0];
                    // 将值添加到对应的数据集
                    values.forEach((value, index) => {
                        espDatasets[index].data.push(value);
                    });
                });
                myChart.data.datasets = espDatasets;
                myChart.update();
            if(jsonResponse.isEnableSunTime == 1){
                document.getElementById('sun_led_controlle_0').style.display = 'none';
                document.getElementById('sun_led_controller_1').style.display = 'block';
            }else{
                document.getElementById('sun_led_controller_0').style.display = 'block';
                document.getElementById('sun_led_controller_1').style.display = 'none';
            }
        //     } else {
        //         console.error('Request failed with status:', xhr.status);
        //     }
        // };
        // xhr.onerror = function () {
        //     console.error('Network error occurred');
        // };
        // xhr.send();
    }

    requestData();

    layui.use(function () {
            var slider = layui.slider;
            // 渲染
            slider.render({
                elem: '#ID-slider-R-input',
                value: [0, 100],
                input: true,
                theme: 'red'
            });
            slider.render({
                elem: '#ID-slider-G-input',
                value: [0, 100],
                input: true,
                theme: 'green'
            });
            slider.render({
                elem: '#ID-slider-B-input',
                value: [0, 100],
                input: true,
                theme: 'blue'
            });
            slider.render({
                elem: '#ID-slider-W-input',
                value: [0, 100],
                input: true,
                theme: 'black' // 主题色
            });
            slider.render({
                elem: '#ID-slider-U-input',
                value: [0, 100],
                input: true,
                theme: 'purple' // 主题色
            });
        });

    layui.use('form', function () {
        var form = layui.form;
        var layer = layui.layer;

        form.on('radio(led-radio-filter)', function (data) {
            var elem = data.elem; // 获得 radio 原始 DOM 对象
            var checked = elem.checked; // 获得 radio 选中状态
            var value = elem.value; // 获得 radio 值
            var othis = data.othis; // 获得 radio 元素被替换后的 jQuery 对象
            if(value == 0){
                document.getElementById('sun_led_controlle_0').style.display = 'none';
                document.getElementById('sun_led_controller_1').style.display = 'block';
            }else{
                document.getElementById('sun_led_controller_0').style.display = 'block';
                document.getElementById('sun_led_controller_1').style.display = 'none';
            }
            layer.msg(['value: ' + value, 'checked: ' + checked].join('<br>'));
        });

        form.on('submit(formUpdate)', function (data) {
            console.log(JSON.stringify(data.field));
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/updata', true);
            xhr.onreadystatechange = function () {
                if (xhr.status === 200) {
                    layer.msg('保存成功!');
                }
            };
            xhr.onerror = function () {
                layer.msg('保存失败,请检查设备是否在线');
            };
            var jsonData = JSON.stringify(jsonResponse);
            xhr.send(jsonData);
            return false;
        });
    });

</script>
</body>

</html>