<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/layui/2.9.6/css/layui.min.css">
    <style>
        body {
            background-color: rgb(250, 250, 250);
        }
    </style>
</head>

<body>
    <H1 style="text-align: center;">ESP32-水族控制板V1.0</H1>
    <div class="layui-tab layui-tab-brief" lay-filter="main-tab">
        <ul class="layui-tab-title">
            <li class="layui-this"><i class="layui-icon layui-icon-console"></i> 鱼缸状态</li>
            <li><i class="layui-icon layui-icon-chart"></i> 灯光配置</li>
            <li><i class="layui-icon layui-icon-water"></i> 换/补水配置</li>
            <li><i class="layui-icon layui-icon-set-sm"></i> 其他配置</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <div style="padding: 16px;">
                    <div class="layui-row layui-col-space15">

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">鱼缸当前温度</div>
                                <div class="layui-card-body">
                                    <H2 id="card-temperature" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">控制器时钟</div>
                                <div class="layui-card-body">
                                    <H2 id="card-ntp" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>


                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">电压</div>
                                <div class="layui-card-body">
                                    <H2 id="card-voltage" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">电流</div>
                                <div class="layui-card-body">
                                    <H2 id="card-current"  style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">风扇功率</div>
                                <div class="layui-card-body">
                                    <H2 id="card-fan-power" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">水位状态</div>
                                <div class="layui-card-body">
                                    <H2 id="card-win-lv" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">下一次换水时间</div>
                                <div class="layui-card-body">
                                    <H2 style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">LED状态(RGBWU)
                                </div>
                                <div class="layui-card-body">
                                    <H2 id="card-led-value" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">LED模式
                                </div>
                                <div class="layui-card-body">
                                    <H2 id="card-led-mode" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">MOS-1状态
                                </div>
                                <div class="layui-card-body">
                                    <H2 id="card-mos1-value"style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">MOS-2状态
                                </div>
                                <div class="layui-card-body">
                                    <H2 id="card-mos2-value" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                        <div class="layui-col-sm3">
                            <div class="layui-card">
                                <div class="layui-card-header layui-font-16" style="text-align: center;">MOS-3状态
                                </div>
                                <div class="layui-card-body">
                                    <H2 id="card-mos3-value" style="text-align: center;">Nan</H2>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- <div class="layui-timeline" style="padding: 16px;">
                    <div class="layui-timeline-item">
                        <i class="layui-icon layui-timeline-axis"></i>
                        <div class="layui-timeline-content layui-text">
                            <h3 class="layui-timeline-title">12月29日</h3>
                            <p>
                                开始补水......
                            </p>
                        </div>
                    </div>
                </div> -->

            </div>

            <div class="layui-tab-item">
                <form class="layui-form" lay-filter="ledForm" action="" id='updateForm' style="padding-right: 40px;">

                    <div class="layui-form-item">
                        <label class="layui-form-label">LED通道</label>
                        <div class="layui-input-block">
                            <select name="ledChannel" lay-filter="led-Channel-value">
                                <option value="1">W</option>
                                <option value="2">WB</option>
                                <option value="3">RGB</option>
                                <option value="4">RGBW</option>
                                <option value="5">RGBWU</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="layui-form-item">
                        <p></p>
                    </div>

                    <div id="sun_led_controller_1" class="layui-form-item">
                        <div class="layui-box">
                            <canvas id='myChart'></canvas>
                        </div>
                    </div>

                    <div id="sun_led_controller_0" class="layui-form-item">
                        <div class="layui-box" style="margin-left: 40px;">
                            <div style="height: 50px;" class="class-r-slider" id="ID-slider-R-input"></div>
                            <div style="height: 50px;" class="class-g-slider" id="ID-slider-G-input"></div>
                            <div style="height: 50px;" class="class-b-slider" id="ID-slider-B-input"></div>
                            <div style="height: 50px;" class="class-w-slider" id="ID-slider-W-input"></div>
                            <div style="height: 50px;" class="class-u-slider" id="ID-slider-U-input"></div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">LED模式</label>
                        <div class="layui-input-block">
                            <input type="radio" name="ledModel" value="0" lay-filter="led-radio-filter" title="手动调节" checked>
                            <input type="radio" name="ledModel" value="1" lay-filter="led-radio-filter" title="日出日落">
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">温控模式</label>
                        <div class="layui-input-block">
                          <input type="checkbox" name="fanAutoSwitch" lay-skin="switch" lay-filter="checkbox-fan-filter" title="自动|手动">
                        </div>
                        <div class="layui-input-block">
                            <div style="height: 50px; padding-top: 12px;" class="class-fan-slider" id="ID-slider-fan-input"></div>
                        </div>
                    </div>

         
                    <div class="layui-form-item" id="fanStartUp-input">
                        <label class="layui-form-label">温控阈值</label>
                        <div class="layui-input-inline" style="width: 200;">
                            <input type="number" name="fanStartUpValue" lay-verify="required" class="layui-input" min="0" step="1" lay-affix="number" value="100">
                        </div>
                    </div>
                    

                    <div class="layui-form-item" style="padding-left: 40px;">
                        <button class="layui-btn layui-btn-fluid" lay-submit
                        lay-filter="ledFormUpdate">保存</button>
                    </div>

                </form>

            </div>

            <div class="layui-tab-item">
                <form class="layui-form" action="" lay-filter="addWatherForm" style="height: 50px; width: 50%;">
                    <div class="layui-form-item">
                      <label class="layui-form-label">补水开关</label>
                      <div class="layui-input-block">
                        <input type="checkbox" name="addWatherSwitch" lay-skin="switch" lay-filter="addWatherSwitch" title="ON|OFF">
                      </div>
                    </div>
                
                     <div class="layui-form-item">    
                        <div class="layui-input-group" style="margin-left: 55px;">
                          <div class=" layui-input-prefix">
                            超时时间
                          </div>
                          <input type="text" name="addWatherTimeout" lay-affix="number" lay-verify="number" placeholder="请输入秒数" autocomplete="off" class="layui-input">
                          <div class="layui-input-suffix">
                            秒
                          </div>
                        </div>
                      </div>

                    <div class="layui-form-item">
                      <div class="layui-input-block">
                        <button type="submit" class="layui-btn" style="width: 80%;" lay-submit lay-filter="addWatherFormUpdate">保存</button>
                      </div>
                    </div>
                  </form>

            </div>
            <div class="layui-tab-item">5</div>
        </div>
    </div>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/layui/2.9.6/layui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.4/dist/chartjs-plugin-dragdata.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    var slider_r;
    var slider_g;
    var slider_b;
    var slider_w;
    var slider_u;
    var slider_fan;

    var jsonResponse = {
    "addWather":{
        "isEnable":0,
        "timeout":10
    }, 
    "waterChanges":{
        "isEnable":0,
        "timeout":10,
        "count":5,
        "clock":{
            "hour":12,
            "minute":0,
            "week":0
        }
    },
    "wifi":{
        "ssid":"",
        "psw":""
    },
    "mqtt":{
        "port":1883,
        "ip":""
    },
    "led":{
        "ledChannelCount":5,
        "isEnableSunTime":0,
        "fanPowerValue":50,
        "fanControlMode":1,
        "fanStartUpValue":100,
        "pwmValuesPerHour":[
            {"0":[0,0,0,0,0]},
            {"1":[0,0,0,0,0]},
            {"2":[0,0,0,0,0]},
            {"3":[0,0,0,0,0]},
            {"4":[0,0,0,0,0]},
            {"5":[0,0,0,0,0]},
            {"6":[0,0,0,0,0]},
            {"7":[0,0,0,0,0]},
            {"8":[0,0,0,0,0]},
            {"9":[10,30,50,20,30]},
            {"10":[20,40,80,30,50]},
            {"11":[30,60,100,80,60]},
            {"12":[40,60,100,100,80]},
            {"13":[50,60,100,100,80]},
            {"14":[40,60,80,100,80]},
            {"15":[30,60,60,80,60]},
            {"16":[20,60,50,60,30]},
            {"17":[10,50,50,50,30]},
            {"18":[10,50,50,40,30]},
            {"19":[10,50,50,40,20]},
            {"20":[10,30,30,30,20]},
            {"21":[10,10,10,10,0]},
            {"22":[10,10,10,10,0]},
            {"23":[10,10,10,10,0]}
        ],
        "rgbwuv":[50,50,50,50,50]
    },
    "pushKey":""
};
    // var jsonResponse = {};
    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"],
            datasets: []
        },
        options: {
            responsive: true,  // 设置图表为响应式
            interaction: {  // 设置每个点的交互
                intersect: true,
            },
            scales: {
                y: {
                    min: 0,
                    max: 100
                }
            },
            plugins: {
                dragData: {
                    round: 0,
                    showTooltip: true,
                    onDragStart: function (e, datasetIndex, index, value) {
                        //   console.log(e)
                    },
                    onDrag: function (e, datasetIndex, index, value) {
                        e.target.style.cursor = 'grabbing'
                        //   console.log(e, datasetIndex, index, value)
                    },
                    onDragEnd: function (e, datasetIndex, index, value) {
                        e.target.style.cursor = 'default'
                        // espDatasets[datasetIndex].data[index] = intValue;
                        jsonResponse.led.pwmValuesPerHour[index][String(index)][datasetIndex] = value;
                        // console.log(espDatasets);
                        console.log(jsonResponse);
                    },
                }
            }
        },
    });

    function updateMyChartVisibility(value) {
        // 定义共享的属性
        var sharedOptions = {
            borderWidth: 1,
            pointHitRadius: 25,
            borderWidth: 3,
            pointRadius: 3,
            // tension: 0.4,
            fill: true,

        };

        // 定义数据集
        var espDatasets = [
            { label: 'R', data: [], pointBackgroundColor: 'red', backgroundColor: 'rgba(255, 0, 0, 0.2)', borderColor: 'red', ...sharedOptions },
            { label: 'G', data: [], pointBackgroundColor: 'green', backgroundColor: 'rgba(0, 255, 0, 0.2)', borderColor: 'green', ...sharedOptions },
            { label: 'B', data: [], pointBackgroundColor: 'blue', backgroundColor: 'rgba(0, 0, 255, 0.2)', borderColor: 'blue', ...sharedOptions },
            { label: 'W', data: [], pointBackgroundColor: 'rgba(0, 0, 0, 0.5)', backgroundColor: 'rgba(0, 0, 0, 0.2)', borderColor: 'rgba(0, 0, 0, 0.5)', ...sharedOptions },
            { label: 'U', data: [], pointBackgroundColor: 'purple', backgroundColor: 'rgba(128, 0, 128, 0.2)', borderColor: 'purple', ...sharedOptions }
        ];
        // 遍历pwmValuesPerHour中的每个对象
        jsonResponse.led.pwmValuesPerHour.forEach(entry => {
            // 获取每个对象的第一个值
            const values = Object.values(entry)[0];
            // 将值添加到对应的数据集
            values.forEach((value, index) => {
                espDatasets[index].data.push(value);
            });
        });
        if (value == 1) {
            espDatasets = espDatasets.filter(function (dataset) {
                return dataset.label == 'W';
            });
        }
        if (value == 2) {
            espDatasets = espDatasets.filter(function (dataset) {
                return dataset.label == 'W' || dataset.label == 'B';
            });
        }
        if (value == 3) {
            espDatasets = espDatasets.filter(function (dataset) {
                return dataset.label == 'R' || dataset.label == 'G' || dataset.label == 'B';
            });
        }
        if (value == 4) {
            espDatasets = espDatasets.filter(function (dataset) {
                return dataset.label != 'U';
            });
        }
        myChart.data.datasets = espDatasets;
        myChart.update();
    }

    function updateLedControllerModelVisibility(value) {
        if (value == 1) {
            document.getElementById('sun_led_controller_1').style.display = 'block';
            document.getElementById('sun_led_controller_0').style.display = 'none';
        } else {
            document.getElementById('sun_led_controller_0').style.display = 'block';
            document.getElementById('sun_led_controller_1').style.display = 'none';
        }
    }


    function updateLedFanModelVisibility(value) {
        if (value == true) {
            document.getElementById('fanStartUp-input').style.display = 'block';
            document.getElementById('ID-slider-fan-input').style.display = 'none';
        } else {
            document.getElementById('fanStartUp-input').style.display = 'none';
            document.getElementById('ID-slider-fan-input').style.display = 'block';
        }
    }


    function updateSliderInputsVisibility(value) {
        var sliders = ['ID-slider-R-input', 'ID-slider-G-input', 'ID-slider-B-input', 'ID-slider-W-input', 'ID-slider-U-input'];
        sliders.forEach(function (sliderId) {
            document.getElementById(sliderId).style.display = 'none';
        });
        var intValue = parseInt(value)
        switch (intValue) {
            case 1:
                document.getElementById('ID-slider-W-input').style.display = 'block';
                break;
            case 2:
                document.getElementById('ID-slider-B-input').style.display = 'block';
                document.getElementById('ID-slider-W-input').style.display = 'block';
                break;
            case 3:
                document.getElementById('ID-slider-R-input').style.display = 'block';
                document.getElementById('ID-slider-G-input').style.display = 'block';
                document.getElementById('ID-slider-B-input').style.display = 'block';
                break;
            case 4:
                document.getElementById('ID-slider-R-input').style.display = 'block';
                document.getElementById('ID-slider-G-input').style.display = 'block';
                document.getElementById('ID-slider-B-input').style.display = 'block';
                document.getElementById('ID-slider-W-input').style.display = 'block';
                break;
            case 5:
                sliders.forEach(function (sliderId) {
                    document.getElementById(sliderId).style.display = 'block';
                });
                break;
            default:
                // 默认情况，不做任何处理
                break;
        }
    }

    layui.use('slider',function () {
        var slider = layui.slider;
        slider_r = slider.render({
            elem: '.class-r-slider',
            min: 0,
            max: 100,
            input: true,
            theme: 'red',
            done: function(value){
                jsonResponse.led.rgbwuv[0] = value;
            }
        });

        slider_g = slider.render({
            elem: '.class-g-slider',
            min: 0,
            max: 100,
            input: true,
            theme: 'green',
            done: function(value){
                jsonResponse.led.rgbwuv[1] = value;
            }
        });

        slider_b = slider.render({
            elem: '.class-b-slider',
            min: 0,
            max: 100,
            input: true,
            theme: 'blue',
            done: function(value){
                jsonResponse.led.rgbwuv[2] = value;
            }
        });

        slider_w = slider.render({
            elem: '.class-w-slider',
            min: 0,
            max: 100,
            input: true,
            theme: 'black',
            done: function(value){
                jsonResponse.led.rgbwuv[3] = value;
            }
        });

        slider_u = slider.render({
            elem: '.class-u-slider',
            min: 0,
            max: 100,
            input: true,
            theme: 'purple',
            done: function(value){
                jsonResponse.led.rgbwuv[4] = value;
            }
        })

        slider_fan = slider.render({
            elem: '.class-fan-slider',
            min: 0,
            max: 100,
            input: true,
            theme: 'black',
            done: function(value){
                jsonResponse.led.fanPowerValue = value;
            }
        })
   
    });

    layui.use('form', function () {
        var form = layui.form;
        var layer = layui.layer;
        form.set({
            autocomplete: 'off' 
        });

        form.on('switch(checkbox-fan-filter)', function (data) {
            var elem = data.elem;
            if(elem.checked == false){
                jsonResponse.led.fanControlMode = 0;
                slider_fan.setValue(jsonResponse.led.fanPowerValue);
                console.log("关闭温控!");
            }else{
                console.log("打开温控!");
                jsonResponse.led.fanControlMode = 1;
            }
            updateLedFanModelVisibility(elem.checked);  
        });


        form.on('select(led-Channel-value)', function (data) {
            var ledMode = form.val().ledModel;
            jsonResponse.led.ledChannelCount = data.value;
            if(ledMode == 0){
                updateSliderInputsVisibility(data.value);
            }else{
                updateMyChartVisibility(data.value);
            }
        });

        form.on('radio(led-radio-filter)', function (data) {
            var elem = data.elem;
            var channel = form.val().ledChannel;
            updateLedControllerModelVisibility(elem.value);
            jsonResponse.led.isEnableSunTime = data.value;
            if(data.value == 0){
                updateSliderInputsVisibility(channel);
            }else{
                updateMyChartVisibility(channel);
            }
        });

        form.on('submit(ledFormUpdate)', function (data) {
            var loadIndex = layer.load(2)
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/updata', true);
            xhr.onreadystatechange = function () {
                if (xhr.status === 200) {
                    layer.close(loadIndex)
                    layer.msg('保存成功!');
                }else{
                    layer.close(loadIndex)
                }
            };
            xhr.onerror = function () {
                layer.close(loadIndex)
                layer.msg('保存失败,请检查设备是否在线');
            };
            var body = {
                "led":{
                    "fanControlMode":jsonResponse.led.fanControlMode,
                    "fanPowerValue":jsonResponse.led.fanPowerValue,
                    "ledChannelCount":jsonResponse.led.ledChannelCount,
                    "isEnableSunTime":jsonResponse.led.isEnableSunTime,
                    "pwmValuesPerHour":jsonResponse.led.pwmValuesPerHour,
                    "fanStartUpValue":parseInt(data.field.fanStartUpValue),
                    "rgbwuv":jsonResponse.led.rgbwuv
                }
            };
            var jsonData = JSON.stringify(body);
            console.log(jsonData);
            xhr.send(jsonData);
            return false;
        });
    });


    function requestData() {
        var loadIndex = layer.load(2)
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/data', true);
        xhr.responseType = 'json';
        xhr.onload = function () {
            if (xhr.status === 200) {
                jsonResponse = xhr.response;
                // 填充表单        
                var form = layui.form;
                layui.form.val("ledForm", {
                    "ledChannel": jsonResponse.led.ledChannelCount,
                    "ledModel": jsonResponse.led.isEnableSunTime,
                    "fanAutoSwitch": jsonResponse.led.fanControlMode,
                    "fanStartUpValue": jsonResponse.led.fanStartUpValue
                });
                layui.form.val("addWatherForm", {
                    "addWatherSwitch": jsonResponse.addWather.isEnable,
                    "addWatherTimeout": jsonResponse.addWather.timeout
                });

                updateLedFanModelVisibility(jsonResponse.led.fanControlMode)
                updateLedControllerModelVisibility(jsonResponse.led.isEnableSunTime);
                if (jsonResponse.led.isEnableSunTime == 1) {
                    updateMyChartVisibility(jsonResponse.led.ledChannelCount);
                } else {
                    updateSliderInputsVisibility(jsonResponse.led.ledChannelCount)
                };
                slider_fan.setValue(jsonResponse.led.fanPowerValue)
                slider_r.setValue(jsonResponse.led.rgbwuv[0]);
                slider_g.setValue(jsonResponse.led.rgbwuv[1]);
                slider_b.setValue(jsonResponse.led.rgbwuv[2]);
                slider_w.setValue(jsonResponse.led.rgbwuv[3]);
                slider_u.setValue(jsonResponse.led.rgbwuv[4]);
                layer.close(loadIndex)
            } else {
                layer.close(loadIndex)
                layer.msg("数据请求失败,请检查设备状态!");
                console.error('Request failed with status:', xhr.status);
            }
        };
        xhr.onerror = function () {
            layer.close(loadIndex)
            layer.msg("数据请求失败,请检查设备状态!");
            console.error('Network error occurred');
        };
        xhr.send();
    }

    $(document).ready(function () {
        console.log('页面加载成功~!');
        // 请求配置信息
        requestData();
        //请求传感器信息
        requestSensorData();
        //开启定时刷新
        setInterval(requestSensorData, 5000);

        function requestSensorData() {
            $.ajax({
                url: '/api/sensor',
                type: 'GET',
                success: function (data) {
                    updateSensorData(data);
                },
                error: function () {
                    layer.msg("数据请求失败,请检查设备状态!");
                }
            });
        }
        // 封装更新页面传感器数据的函数
        function updateSensorData(data) {
            document.getElementById("card-temperature").innerHTML = data.temperatureData + "°";
            document.getElementById("card-voltage").innerHTML = data.voltage + "V";
            document.getElementById("card-current").innerHTML = data.current + "A";
            document.getElementById("card-led-value").innerHTML = data.ledPwmValues;
            document.getElementById("card-win-lv").innerHTML = data.waterLevelIn == 0 ? "低水位" : "正常";
            document.getElementById("card-mos1-value").innerHTML = data.mos_b1 == 0 ? "关闭" : "打开";
            document.getElementById("card-mos2-value").innerHTML = data.mos_b2 == 0 ? "关闭" : data.mos_b2 + "%";
            document.getElementById("card-mos3-value").innerHTML = data.mos_b3 == 0 ? "关闭" : data.mos_b3 + "%";
            document.getElementById("card-led-mode").innerHTML = jsonResponse.led.isEnableSunTime == 0 ? "手动模式" : "日出日落";
            document.getElementById("card-fan-power").innerHTML = jsonResponse.led.fanPowerValue;
            document.getElementById("card-ntp").innerHTML = data.ntpValue;
            console.log(data);
        }

    });

</script>
</body>

</html>